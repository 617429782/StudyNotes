周一
  1. DSL变量作用域重构方案
    需求背景
      当前方案简述
        1. 全面基于vuex管理状态
        2. 采用 scope + source 的变量管理模式
          scope 保留值一览
            $page
            $ref: 
      存在的问题
        1. 当多个DSL片段整合时，没有产生隔离效果
        2. 部分场景取值有问题，比如 v-model: 'A', v-model: 'A[0]'

    新方案设计
      scope: app + page + module + com 

      '$app': {
        username: 'zhangsan'
      }

      '$app/$homePage': {
        
      }

      '$app/$homePage/$message': {
        
      }

      '$app/$homePage/$message/$table': {
        list: [],
        page: 1,
        pageSize: 20
      }

      '$app/$homePage/$message/$modal: {
        form: {

        }
      }


    测试用例


  2. 自定义组件
    {
      "el_name": "CustomCom",
      "el_type": "component",
      "el_state": {
        "xxx": 1
      },
      "el_children": [
        {
          "el_name": "xxx",
          "el_props": {
            "abc": {
              "el_scope": "$props",
              "el_source": "customProps"
            },
            "bcd": {
              "el_scope": "$state",
              "el_source": "customState"
            }
          }
        }
      ]
    }

    Vue.component('', )

周二
  今日工作内容
    Vue.component 执行时机
    现象:
      1. 在 created 中注册组件，可以被识别
      2. 在 beforeUpdate 中注册组件，无法被识别
      3. watch 的执行时机在 beforeUpdate 之前，在 watch 中注册组件，无法被识别

    测试用例
      {
        "el_name": "CustomCom"
      }

      VueComponentBuilder.getInstance().registerVueComponent('CustomCom', {
        "el_name": "CustomCom",
        "el_type": "component",
        "el_state": {
          "xxx": 1
        },
        "el_children": [
          {
            "el_store": {
              "A": {
                "B": {
                  "C": {
                    "D": "hello"
                  }
                }
              }
            },
            "el_name": "mtd-input",
            "el_props": {
              "v_model": "A.B.C.D"
            }
          }
        ]
      }, this);

      Vue.options['components']

      Vue.component('Test', {
        render(c) {
          return c('p', {}, [c('span', '123')])
        }
      })


      "el_name": "div",
      "el_children": [
        {
          "el_name": "Test"
        },
        {
          "el_name": "Test"
        }
      ]

  明日工作计划

  心得
    Vue 的官方文档(https://cn.vuejs.org/v2/guide/components-registration.html)中有一句: 
      全局注册组件的行为必须在根 Vue 实例 (通过 new Vue) 创建之前发生
      这个限制的原因是，Vue在模版编译阶段需要解析 html片段，如果不能在这之前注册，Vue无法解析出自定义的组件如 <SkyRender />
      因此，在业务代码中注册全局组件的时机应该有三处，分别是 new Vue 之前、beforeCreate钩子、created钩子 (准确地说, 是在 vue.$mount 执行前)

    SkyRender 是以plugin的形式注入到Vue中，作用是全局注册一个自定义组件，plugin的执行时机在 Vue实例创建前，因此可以生效

    要实现DSL支持自定义组件，需要 可视化编辑器侧 向 <SkyRender /> 传递 声明组件的DSL片段，在 <SkyRender /> 的 beforeCreate钩子/created钩子 中完成组件注册
    同时，为 <SkyRender /> 增加 key(用 声明组件的DSL片段 计算得到)，通过 key 的变更绕过 vue 的组件复用机制，销毁并重新创建 <SkyRender />

    (虽然在 声明组件的DSL片段 变更时，需要触发 <SkyRender /> 的销毁和重新创建，带来额外的开销，但在真实的使用中，声明组件的DSL片段 变更并不频繁，暂时没有观察到性能瓶颈)

周三
  sky-render
    DSL
    customMethods: 
    hoc:
    config
      updateSource: dsl | internal
    customCompList: 自定义组件列表, 用于 DSL 片段的复用

  渲染器运行流程
    [天河.md](../../项目资料/天河.md)


  function deep(head, result = []) {
    result.push(head)
    head?.$children.forEach(v => {
      deep(v, result)
    })
    return result
  }
  var list = deep(app.__vue__)

周四
  自定义DSL组件
  [自定义DSL组件.md](../../需求设计/自定义DSL组件.md)

周五
  变量作用域
  scope + source + sourceType 的模式用于在 store 中 取值 和 赋值

  scope 保留值一览
    功能型 (不出现在 vuex 的 store 下)
      $props: 仅用于 DSL组件定义 的场景，作为 接受参数的占位符，对标 Vue组件的 props 属性, 详见 自定义DSL组件
      $state: 仅用于 DSL组件定义 的场景，作为 内部参数变量，对标 Vue组件的 data 属性, 详见 自定义DSL组件
      $route: 对标 vue-router 的路由参数
      todo $iterator: 仅用于 for循环的场景，

    数据型 (挂在 vuex 的 store 下，用于状态的存取)
      $global: 
        示例
        ```
          {

          }
        ```


      $page: 页面级 数据，当 url 发生变化时进行销毁
      $slot:
      $iterator:

  生命周期导致的渲染异常问题
    复现
    ```
      {
        "el_name": "div",
        "el_lifeCycle": {
          "created": [
            {
              "el_name": "setData",
              "el_type": "action",
              "el_props": {
                "params": {
                  "datas": [
                    {
                      "id": 1,
                      "name": "交易",
                      "features": [
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "支付方式说明"
                        },
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "代扣页标题"
                        }
                      ]
                    },
                    {
                      "id": 2,
                      "name": "退款",
                      "features": [
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "支付方式说明"
                        },
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "代扣页标题"
                        }
                      ]
                    },
                    {
                      "id": 3,
                      "name": "结算",
                      "features": [
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "支付方式说明"
                        },
                        {
                          "featureCategoryName": "签约展示",
                          "featureName": "代扣页标题"
                        }
                      ]
                    }
                  ]
                },
                "set": {
                  "el_scope": "operation2a7ab077563a4d44bf12808ca4e072fe",
                  "el_source": "服务code",
                  "el_source_type": "set"
                }
              }
            },
            {}
          ]
        },
        "el_children": [
          {
            "el_name": "mtd-row",
            "el_children": [
              {
                "el_name": "mtd-col",
                "el_type": "sample",
                "el_props": {
                  "span": 15
                },
                "el_children": [
                  {
                    "el_name": "mtd-tabs",
                    "el_style": {
                      "marginTop": "20px"
                    },
                    "el_props": {
                      "type": "card",
                      "value": {
                        "el_scope": "operation2a7ab077563a4d44bf12808ca4e072fe",
                        "el_source_type": "get",
                        "el_source": "currentTab"
                      },
                      "input": {
                        "el_scope": "operation2a7ab077563a4d44bf12808ca4e072fe",
                        "el_source_type": "set",
                        "el_source": "currentTab"
                      }
                    },
                    "el_children": [
                      {
                        "el_name": "mtd-tab-pane",
                        "el_props": {
                          "label": "产品信息",
                          "value": 0
                        },
                        "el_children": [
                          {
                            "el_name": "Form",
                            "el_style": {
                              "margin-top": "35px",
                              "margin-bottom": "10px"
                            },
                            "el_props": {
                              "inline": false,
                              "label-width": 200,
                              "formConfig": {
                                "basicServiceNmae": {
                                  "label": "基础服务名称",
                                  "required": true
                                },
                                "describe": {
                                  "label": "描述",
                                  "required": true
                                }
                              },
                              "basicServiceNmae": {
                                "el_name": "mtd-input",
                                "el_props": {
                                  "readonly": true,
                                  "v_model": "operation2a7ab077563a4d44bf12808ca4e072fe.服务code.basicServiceNmae"
                                }
                              },
                              "describe": {
                                "el_name": "mtd-input",
                                "el_props": {
                                  "readonly": true,
                                  "v_model": "operation2a7ab077563a4d44bf12808ca4e072fe.服务code.describe"
                                }
                              }
                            }
                          }
                        ]
                      },
                      {
                        "el_name": "mtd-tab-pane",
                        "el_props": {
                          "label": "服务特征",
                          "value": "1"
                        },
                        "el_children": [
                          {
                            "el_name": "div",
                            "el_children": ["123"]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ```
